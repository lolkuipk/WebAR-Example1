markerRoots.push(markerRoot);

                    new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                        type: "barcode",
                        barcodeValue: patternBarcode[i],
                    });

                    // Завантаження зображень
                    new THREE.TextureLoader().load(imageFiles[i], (texture) => {
                        let ratio = texture.image.naturalWidth / texture.image.naturalHeight;
                        let geometry = (texture.image.naturalHeight < texture.image.naturalWidth) ?
                            new THREE.PlaneGeometry(ratio, 1) :
                            new THREE.PlaneGeometry(1, 1 / ratio);

                        let material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
                        let mesh = new THREE.Mesh(geometry, material);
                        mesh.rotation.x = -Math.PI / 2;
                        markerRoot.add(mesh);
                    }, undefined, (error) => {
                        console.error(`Помилка завантаження зображення: ${imageFiles[i]}`, error);
                    });

                    // Завантаження аудіо
                    if (audioFiles[i]) {
                        audioLoader.load(audioFiles[i], (buffer) => {
                            let sound = new THREE.Audio(listener);
                            sound.setBuffer(buffer);
                            sound.setLoop(false);
                            audioSources.set(patternBarcode[i], sound);
                        }, undefined, (error) => {
                            console.error(`Помилка завантаження аудіо: ${audioFiles[i]}`, error);
                        });
                    }
                }
            }

            function onResize() {
                arToolkitSource.onResize();
                arToolkitSource.copySizeTo(renderer.domElement);
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
                }
            }

            function update() {
                if (arToolkitSource.ready) {
                    arToolkitContext.update(arToolkitSource.domElement);

                    markerRoots.forEach((markerRoot, index) => {
                        let barcodeID = index + 1;
                        if (arToolkitContext.arController.barcodeMarkers[barcodeID]?.inCurrent) {
                            let sound = audioSources.get(barcodeID);
                            if (sound && !sound.isPlaying) {
                                sound.play();
                            }
                        } else {
                            let sound = audioSources.get(barcodeID);
                            if (sound && sound.isPlaying) {
                                sound.stop();
                            }
                        }
                    });
                }
            }

            function render() {
                renderer.render(scene, camera);
            }

            function animate() {
                requestAnimationFrame(animate);
                update();
                render();
            }
        }

        access.addEventListener('click', () => {
            access.style.display = 'none';
            initiateExperience();
        });
    </script>
</body>
</html>